services:
  # Main development environment
  projectodyssey-dev:
    user: "${USER_ID}:${GROUP_ID}"
    build:
      context: .
      dockerfile: Dockerfile
      target: development
      args:
        USER_ID: ${USER_ID}
        GROUP_ID: ${GROUP_ID}
    image: projectodyssey:dev
    volumes:
      - .:/workspace:delegated
      - pixi-cache:${HOME}/.pixi
      - pre-commit-cache:/home/dev/.cache/pre-commit
      - ${HOME}/.gitconfig:/home/dev/.gitconfig:ro
    environment:
      - HOME=/home/dev
      - USER_ID=${USER_ID}
      - GROUP_ID=${GROUP_ID}
      - ENVIRONMENT=development
      - TERM=xterm-256color
      - PIXI_HOME=${HOME}/.pixi
    working_dir: /workspace
    stdin_open: true
    tty: true
    command: /bin/bash

  # CI/Testing environment
  projectodyssey-ci:
    user: "${USER_ID}:${GROUP_ID}"
    build:
      context: .
      dockerfile: Dockerfile
      target: ci
      args:
        USER_ID: ${USER_ID}
        GROUP_ID: ${GROUP_ID}
    image: projectodyssey:ci
    volumes:
      - .:/workspace
      - pixi-cache:${HOME}/.pixi
    environment:
      - HOME=/home/dev
      - USER_ID=${USER_ID}
      - GROUP_ID=${GROUP_ID}
      - ENVIRONMENT=ci
      - CI=true
      - PIXI_HOME=${HOME}/.pixi
    working_dir: /workspace

  # Production environment
  projectodyssey-prod:
    user: "${USER_ID}:${GROUP_ID}"
    build:
      context: .
      dockerfile: Dockerfile
      target: production
      args:
        USER_ID: ${USER_ID}
        GROUP_ID: ${GROUP_ID}
    image: projectodyssey:prod
    volumes:
      - .:/workspace:ro
    environment:
      - HOME=/home/dev
      - USER_ID=${USER_ID}
      - GROUP_ID=${GROUP_ID}
      - ENVIRONMENT=production
      - PIXI_HOME=${HOME}/.pixi
    working_dir: /workspace

volumes:
  pixi-cache:
    driver: local
  pre-commit-cache:
    driver: local
